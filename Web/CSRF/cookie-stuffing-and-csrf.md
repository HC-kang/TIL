# 쿠키 스터핑과 CSRF

올해 초 쯤, 커뮤니티에서 '허니'라는 크롬 익스텐션이 논란이 되었던 적이 있었습니다.  
잘 모르시는 분들을 위해 간략하게만 설명드리면, 이 허니라는 익스텐션은 사용자에게 특정 쇼핑몰 등의 할인 쿠폰을 자동으로 찾아서 적용해주는 서비스였는데요, 설명만 들으면 안쓰는 사람만 바보가 아닌가 싶을 정도로 좋은 도구죠.  

<image src="./images/honey-logo.png" width="500px" />

그런데 여기서, 몇가지 문제점이 알려지게 됩니다.  
자세한 내용이 궁금하신 분들은 [관련 기사](https://openads.co.kr/content/contentDetail?contsId=15574)나 코딩애플(~~어둠의 생활코딩~~)님의 [유튜브 영상](https://www.youtube.com/watch?v=EsqBuwOuXB0)도 많이 있으니, 한번쯤 찾아보시는것도 좋을 것 같습니다.  

자, 서론은 여기까지 하고, 결국 이 익스텐션의 문제점을 다시 말해보자면 '사용자 몰래 쿠키를 조작해서 이익을 챙겼다'는 점입니다.  
물론 정확히 추산 할 수는 없겠지만 원래 그 쿠폰, 추천인 등으로 이익을 받았어야 할 인플루언서들의 피해도 상당할 겁니다.  

이런 사건을 그냥 쿠키를 사용한 단순한 어뷰징으로 치부하고 넘어갈 수도 있겠지만, 저는 이 사건을 보고 웹 공격 기법 중 하나인 `CSRF`(Cross-Site Request Forgery)가 떠오르더라구요. 물론 엄밀한 정의는 다르지만, "이런 쿠키 스터핑도 CSRF의 한 형태로 볼 수 있지 않을까?" 하는 질문에서부터 오늘의 글을 시작해보려 합니다.

## 쿠키 스터핑: 문제점은 무엇일까?

<image src="./images/cookie-stuffing.png" width="500px" />

먼저 '쿠키 스터핑(Cookie Stuffing)'이 어떻게 동작하는지 간단히 짚고 넘어가겠습니다.

웹 브라우저와 쿠키에 대해 잘 모르시는분들을 위해 간단히 첨언하자면, 쿠키는 간단한 데이터를 클라이언트, 즉 사용자의 브라우저에 일시적으로 저장해두기 위해 사용되는 기술입니다.  

이를 통해 **사용자를 증명(로그인 관리)** 하거나, **특정 상태값(다크모드)을 유지**하거나, **특정 정보(이 사용자는 언제 방문했었음)를 저장**해두는 등의 용도로 사용됩니다.  

주요한 특징은 **브라우저가 매 요청에 자동으로 쿠키를 첨부한다는 점**입니다.  
이 부분이 바로 오늘의 포인트이자 우리가 항상 주의하고, 해결해야할 문제점이기도 합니다.

### 정상적인 경우

자 그러면 이제, 정상적인 경우를 먼저 살펴보겠습니다.  

<image src="./images/cookie-valid-use.png" width="600px" />

> [정상적인 경우]
> 1. 사용자가 인플루언서 등의 소개로 얻은 정보를 바탕으로 제품 구매 페이지로 이동합니다. 이 과정에서 사용자의 브라우저에는 추천인 쿠키가 심어집니다.
> 2. 사용자가 제품을 결제합니다. 이때 **쿠키는 자동으로 서버에 전송**됩니다.
> 3. 서버는 쿠키를 확인하고, 추천인에게 보상을 지급합니다.

이 경우에는 쿠키를 통해 '이 사용자는 누구의 추천을 통해 여기에 방문했다'라는 정보를 저장해두는 것이 목적이죠. 그래야 이를 통해 추천인에게 보상을 지급할 수 있기 때문입니다.  

### 문제가 되는 경우

그러면 이제 문제가 되는 경우를 살펴보겠습니다.  

<image src="./images/cookie-invalid-use.png" width="600px" />

> [쿠키 스터핑 사례]
> 1. (위와 동일)사용자가 인플루언서 등의 소개로 얻은 정보를 바탕으로 제품 구매 페이지로 이동합니다. 이 과정에서 사용자의 브라우저에는 추천인 쿠키가 심어집니다.
> 2. 쿠키 추천 익스텐션이 쿠폰을 찾으면서 **사용자 몰래 자신의 추천인 쿠키를 심습니다.** 이 과정에서 사용자에게 제품을 소개해 준 **인플루언서의 추천인 쿠키가 덮어씌워**집니다.
> 3. (위와 동일)사용자가 제품을 결제합니다. 이때 쿠키는 자동으로 서버에 전송됩니다.
> 4. (위와 동일)서버는 쿠키를 확인하고, 추천인에게 보상을 지급합니다.

## CSRF: 많이 들어는 봤는데..

그렇다면 CSRF(Cross-Site Request Forgery)는 무엇일까요?  
CSRF의 핵심 구성요소는 다음과 같습니다.  

> [CSRF의 핵심 구성요소]
> 1. 사이트 간 요청(Cross-Site): 일반적으로 공격자는 실제 운영중인 서비스 내의 코드를 직접 조작할수 없습니다. 따라서 **자신이 작성한, 혹은 자신이 조작할 수 있는 다른 사이트**를 통해 피해 대상 사이트로 요청을 보내는 방식으로 공격합니다.
> 2. 사용자 의사와 무관한 요청(Request Forgery): 그중에서도 특히, 사용자가 의도하지 않은 요청을 공격자가 원하는 대로 전송하는 것을 의미합니다.
> 3. 이때 꼭 필요한 특성이 있는데, 이것이 바로 **사용자의 브라우저가 자동으로 쿠키를 첨부하는 특성**을 이용하는 것입니다.
> 4. (+@) 추가적으로, HTTP 요청은 모두 독립적이기에, 누구나 마치 '나'처럼 요청을 보낼 수 있다는 점도 중요합니다.

이제 이걸 시나리오로 좀 더 이해하기 쉽게 풀어보자면, 아래와 같습니다

## CSRF 시나리오로 이해해보기

여기부터 CSRF가 실제로 어떻게 동작하는지 시나리오로 살펴보겠습니다.

### 일반적인 CSRF 공격 시나리오

<image src="./images/csrf-scenario.png" width="600px" />

> [CSRF 공격 예시]
> 1. 사용자가 은행 사이트에 로그인합니다. 브라우저에 인증 쿠키가 저장되죠.
> 2. 사용자가 로그아웃하지 않고 다른 탭에서 공격자의 사이트를 방문합니다.
> 3. 공격자의 사이트에는 은행으로 송금 요청을 보내는 숨겨진 코드가 있습니다.
> 4. 사용자 모르게 브라우저가 은행으로 송금 요청을 보냅니다. **이때 인증 쿠키가 자동으로 포함됩니다.**
> 5. 은행은 정상적인 요청으로 판단하고 송금을 처리합니다.  

핵심은 "브라우저가 쿠키를 자동으로 보낸다"는 점입니다. 공격자는 이 특성을 악용해 사용자가 의도하지 않은 요청을 보내게 만들죠.  

## 쿠키 스터핑과 CSRF의 공통점

두개의 개념은 본질적으로는 꽤나 다릅니다. 하나는 단순히 얌체같은 쿠키 조작이고, 다른 하나는 정말 큰 위협이 될수도 있는 웹 공격 기법 중 하나니까요.  
하지만 본질적으로는 둘 다 브라우저의 편의 기능을 악용해서 사용자를 기만한다는 점에서 공통점이 있습니다.  

### 1. 사용자의 의도와 무관한 동작
- **CSRF**: "아니, 나는 송금하려고 한 적이 없는데?"
- **쿠키 스터핑**: "어? 나는 추천인을 바꾸려고 한 적이 없는데?"

### 2. 브라우저의 자동 동작 악용
- **CSRF**: 쿠키 자동 전송을 악용
- **쿠키 스터핑**: 쿠키 자동 저장/덮어쓰기를 악용

## 개발자로서 할 수 있는 일들

그래서 우리가 실제로 뭘 할 수 있을까요? 몇 가지 실용적인 방법들을 소개해드리겠습니다.

### 1. 쿠키 설정 시 보안 옵션 활용하기

```javascript
// 민감한 정보를 쿠키에 저장할때는 보안 옵션을 추가해주세요.
res.cookie('referral', referralId, {
    httpOnly: true,    // JavaScript로 접근 불가
    secure: true,      // HTTPS에서만 전송
    sameSite: 'lax',   // 크로스 사이트 요청 제한
    maxAge: 86_400_000   // 24시간 유효
});
```

### 2. CSRF 토큰 사용하기

```javascript
// 서버와 클라이언트가 모두 알고있는 토큰을 매번 '직접 첨부'하는 방식으로 사용합니다.
const csrfToken = "l23d4ktif..";

// 폼 제출 시 토큰 포함
form.append('csrfToken', csrfToken);

// 또는 헤더에 포함
fetch(url, {
    method: 'POST',
    headers: {
        'X-CSRF-Token': csrfToken
    }
});
```
// TODO
## 마치며

쿠키 스터핑 사건을 보면서 CSRF를 떠올린 건, 단순한 학술적 호기심이 아니었습니다. **웹의 기본 동작 원리가 어떻게 악용될 수 있는지** 이해하는 것이 정말 중요하다고 생각했거든요.

우리가 당연하게 여기는 것들 - 쿠키의 자동 전송, 브라우저의 신뢰 모델 - 이 때로는 취약점이 될 수 있습니다. 이를 이해하고 대비하는 것이 개발자의 책임이겠죠.

사실 완벽한 보안은 없습니다. 하지만 원리를 이해하고, 계속 개선해나가는 자세가 중요하다고 생각해요. 

여러분은 어떻게 생각하시나요? 
혹시 비슷한 경험이 있으신가요?
댓글로 의견 남겨주시면 함께 이야기 나눠보면 좋겠네요!

---

*보안은 혼자 하는 게 아니라 함께 만들어가는 거라고 생각합니다. 이 글이 조금이나마 도움이 되었으면 좋겠네요.*