# 쿠키 스터핑과 CSRF

최근 커뮤니티에서 논란이 되었던 '할인 쿠폰 소개 사이트'의 추천인 쿠키 바꿔치기 이슈를 기억하시나요? 사용자가 특정 사이트를 방문했을 뿐인데, 눈 깜짝할 사이에 새 탭이 열렸다 닫히면서 나도 모르게 특정 서비스의 추천인 쿠키가 심어지는 방식이었죠.

단순한 어뷰징으로 치부하고 넘어갈 수도 있지만, 저는 이 현상을 보면서 웹 보안의 고전적인 공격 기법 중 하나인 CSRF(Cross-Site Request Forgery)를 떠올렸습니다. "이런 쿠키 스터핑(Cookie Stuffing)도 과연 CSRF의 한 형태로 볼 수 있을까?" 이 질문에서부터 오늘의 이야기를 시작해보려 합니다.

쿠키 스터핑: 무엇이 문제인가?
먼저 '쿠키 스터핑'이 어떻게 동작하는지 간단히 짚고 넘어가겠습니다.

사용자: 특정 정보(예: 할인 정보)를 얻기 위해 A 사이트(쿠폰 모음 사이트)를 방문합니다.
공격자(A 사이트 운영자): A 사이트에 접속한 사용자의 브라우저에서, 사용자 몰래 새 탭이나 숨겨진 iframe을 통해 B 사이트(실제 커머스 또는 서비스)의 특정 추천인 링크를 순간적으로 로드합니다.
브라우저: 이 요청으로 인해 B 사이트의 추천인 쿠키가 사용자의 브라우저에 심어지거나, 기존 쿠키가 공격자의 것으로 덮어씌워집니다. 사용자는 이 과정을 인지하지 못하는 경우가 대부분입니다.
결과: 이후 사용자가 실제로 B 사이트에서 상품을 구매하거나 서비스를 이용하면, 이전에 심어진 쿠키 때문에 A 사이트 운영자에게 부당한 추천인 수익이 돌아갑니다.
핵심은 사용자가 명시적으로 의도하거나 인지하지 못한 상태에서 브라우저의 쿠키 상태가 변경된다는 점입니다.

CSRF의 핵심 원리 다시 보기
그렇다면 CSRF는 무엇이었을까요? CSRF의 핵심 구성요소는 다음과 같습니다.

사용자 의사와 무관한 요청 (Request Forgery): 사용자가 특정 웹사이트에 로그인된 상태에서, 자신의 의지와는 무관하게 공격자가 의도한 특정 요청(예: 글 삭제, 비밀번호 변경, 송금)이 해당 웹사이트로 전송되는 것을 의미합니다.
사이트 간 요청 (Cross-Site): 이러한 악의적인 요청은 사용자가 현재 접속해 있는 사이트(공격자가 제어하는 사이트 또는 악성 스크립트가 삽입된 사이트)에서 시작되어, 다른 사이트(피해 대상이 되는 사이트)로 전송됩니다.
이때, 브라우저는 타겟 사이트로 요청을 보낼 때 해당 사이트의 인증 쿠키를 자동으로 첨부하는 특성을 이용하는 경우가 많습니다.

쿠키 스터핑, CSRF의 정의에 대입해보기
이제 앞서 설명한 쿠키 스터핑 시나리오를 CSRF의 정의에 대입해 보겠습니다.

'사용자 의사와 무관한 요청 (Request Forgery)' 관점:
사용자는 단순히 A 사이트에서 정보를 얻으려 했을 뿐, B 사이트의 추천인 쿠키를 변경하는 요청을 직접 보내거나 동의한 적이 없습니다. A 사이트가 몰래 새 탭을 열어 B 사이트의 특정 URL을 로드하도록 한 행위는, 사용자의 브라우저가 사용자의 명시적 의도와 무관하게 특정 HTTP 요청을 수행하도록 강제한 것입니다. 이는 '요청 위조'의 본질과 맞닿아 있습니다.

'사이트 간 요청 (Cross-Site)' 관점:
A 사이트에서 시작된 이 '요청'은 실제 커머스 사이트인 B 사이트 또는 그 제휴사 페이지로 향합니다. 이는 명백히 '사이트 간' 특성을 보여줍니다.

결과로서의 '상태 변경':
이 위조된 요청의 결과로, 사용자의 브라우저에 저장된 B 사이트 관련 쿠키(클라이언트 측 '상태')가 공격자가 원하는 대로 변경됩니다. 이 변경된 상태는 추후 사용자가 B 사이트와 상호작용할 때 (예: 상품 구매 시) 추천인 판별에 영향을 미칩니다.

그렇다면, 쿠키 스터핑은 CSRF인가?
결론부터 말씀드리면, 네, CSRF의 핵심 정의 요소에 비추어 볼 때 쿠키 스터핑은 넓은 의미에서 CSRF의 한 형태로 볼 수 있습니다.

물론, 우리가 흔히 'CSRF'라고 할 때는 사용자가 로그인된 세션을 이용하여 서버 측의 데이터를 직접 조작하는 행위(예: "/transfer_money", "/delete_account" 등의 엔드포인트 호출)를 주로 떠올립니다. 그리고 쿠키 스터핑은 그 자체로도 특정 어뷰징 패턴을 지칭하는 고유한 용어로 사용됩니다.

하지만 중요한 것은 용어의 엄밀한 분류 그 자체보다, **"사용자의 브라우저가 사용자의 명시적이고 충분히 인지된 동의 없이, 공격자가 원하는 방식으로 다른 웹사이트와 상호작용하도록 조종당했는가?"**라는 근본적인 질문입니다. 쿠키 스터핑 시나리오에서 이 질문에 대한 답은 명백히 "예"입니다.

이러한 관점이 왜 중요할까요?
근본 원인에 대한 이해 증진: 개별 어뷰징 사례를 넘어서, 웹 공격이 어떻게 브라우저의 기본 동작 원리나 사용자의 신뢰를 악용하는지에 대한 깊이 있는 이해를 돕습니다.
방어 전략에 대한 시야 확장: 쿠키 스터핑에 전통적인 Anti-CSRF 토큰 방식이 직접 적용되기는 어려울 수 있습니다. (주로 상태 변경 없는 GET 요청으로 쿠키를 심고, 즉각적인 서버 액션이 아니기 때문입니다). 하지만 요청의 출처와 신뢰성을 검증하려는 CSRF 방어의 근본적인 정신은 여전히 유효합니다. 백엔드 개발자로서 추천인 유입 경로의 신뢰성을 다각도로 검증하거나, 쿠키 설정에 대한 더욱 엄격한 정책을 고민하는 계기가 될 수 있습니다.
보안적 사고의 확장: 특정 공격을 이미 알려진 이름으로만 분류하고 넘어가는 대신, 그 기본 원리를 파악하려 노력할 때 우리는 더 많은 잠재적 위협을 인지하고 더 견고한 시스템을 설계할 수 있습니다.
결론: 원리를 알면 더 많은 것이 보인다
쿠키 스터핑과 CSRF를 연결 지어 생각해보는 것은, 우리가 매일 사용하는 웹 기술의 이면에 숨겨진 복잡성과 잠재적 취약점을 더 깊이 이해하는 하나의 방법입니다.

단순히 "이건 쿠키 스터핑이라는 어뷰징이야"라고 규정짓고 넘어가기보다, "이것이 왜 가능한 걸까? 어떤 웹의 기본 원리를 악용한 것일까?"라고 한 번 더 질문을 던져보는 것이죠. 이러한 고민과 분석이야말로 우리 개발자들이 더 안전하고 신뢰할 수 있는 웹 환경을 만드는 데 기여하는 길이라고 생각합니다.

여러분의 생각은 어떠신가요? 혹시 이와 유사한 다른 사례나 다른 관점이 있다면 댓글로 자유롭게 공유해주세요!

[백엔드 개발자로서의 추가 코멘트]

이러한 쿠키 스터핑을 완전히 방지하는 것은 백엔드만의 노력으로 어려울 수 있습니다. 하지만 백엔드는 추천인 유효성 검증 로직을 강화하여 피해를 최소화할 수 있습니다. 예를 들어, 추천인 쿠키가 설정된 시점, 사용자의 유입 경로, IP 주소의 변경 빈도 등 다양한 요소를 종합적으로 분석하여 비정상적인 패턴을 감지하고, 이에 대한 알림이나 제한 조치를 취하는 것을 고려해볼 수 있습니다. 프론트엔드에서는 SameSite 쿠키 속성을 Lax 또는 Strict로 설정하는 것이 일부 도움이 될 수 있지만, 모든 케이스를 막을 수는 없습니다. 결국 다층적인 방어 전략이 중요합니다.






