<html>

<head>
  <meta charset="UTF-8">
  <title>Painter</title>
  <script>

    // drawing tool values
    var LINE_DRAW_TYPE      = 0;
    var RECTANGLE_DRAW_TYPE = 1;
    var ELLIPSE_DRAW_TYPE   = 2;
    var FREE_PATH_DRAW_TYPE = 3;

    // current drawing tool type value
    var g_DrawType = LINE_DRAW_TYPE;

    // set global variable for mousedown event coordinates
    var g_pressPoint = null;

    window.onload = function () {
      // bring toolbar components
      var toolbar = document.getElementById("toolbar");

      var inputImage = createButton("./images/line.gif", "btnLine");
      toolbar.appendChild(inputImage);

      inputImage = createButton("./images/rectangle.gif", "btnRectangle");
      toolbar.appendChild(inputImage);

      inputImage = createButton("./images/ellipse.gif", "btnEllipse");
      toolbar.appendChild(inputImage);

      inputImage = createButton("./images/free_path.gif", "btnFreePath");
      toolbar.appendChild(inputImage);

      // bring canvas components
      var canvas = document.getElementById("mycanvas");
      canvas.width = 600;
      canvas.height = 400;
      canvas.style.border = "1px solid gray";
      canvas.style.cursor = "pointer";

      // bring canvas rendering context
      var ctx = canvas.getContext("2d");

      // set canvas graphic attributes
      ctx.lineWidth = 10;
      ctx.strokeStyle = "red";
      ctx.fillStyle = "blue";

      // add event listeners on draw tool select button
      var btnLine      = document.getElementById("btnLine");
      var btnRectangle = document.getElementById("btnRectangle");
      var btnEllipse   = document.getElementById("btnEllipse");
      var btnFreePath  = document.getElementById("btnFreePath");

      btnLine.addEventListener("click", function (e) {
        setDrawType(LINE_DRAW_TYPE);
      }, false)
      btnRectangle.addEventListener("click", function (e) {
        setDrawType(RECTANGLE_DRAW_TYPE);
      }, false)
      btnEllipse.addEventListener("click", function (e) {
        setDrawType(ELLIPSE_DRAW_TYPE);
      }, false)
      btnFreePath.addEventListener("click", function (e) {
        setDrawType(FREE_PATH_DRAW_TYPE);
      }, false)

      // add mouseDown event listener on canvas
      canvas.addEventListener("mousedown", function (e) {
        console.log("mouseDown");
        var canvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // set current mouse position
        g_pressPoint = relativePosition(e, canvas);

        // register mousemove event listener
        var mousemoveEventListener = function (e) {
          console.log("mouseMove");
          // restore canvas image data
          ctx.putImageData(canvasImageData, 0, 0);

          // get current mouse position
          var movePoint = relativePosition(e, canvas);

          // draw line
          drawing(ctx, movePoint);
        };

        document.addEventListener("mousemove", mousemoveEventListener, false);

        // add mouseUp event listener on canvas
        document.addEventListener("mouseup", function (e) {
          console.log("mouseUp");
          // relative position of mouseup pointer on canvas
          var upPoint = relativePosition(e, canvas);

          // restore canvas image data
          ctx.putImageData(canvasImageData, 0, 0);

          // draw line
          drawing(ctx, upPoint);

          // remove mousemove event listener
          document.removeEventListener("mousemove", mousemoveEventListener, false);

          // remove mouseup event listener
          document.removeEventListener("mouseup", arguments.callee, false);
      })
      }, false)
    };

    function createButton(imagePath, id) {
      var inputImage = document.createElement("input");
      inputImage.setAttribute("type", "image");
      inputImage.setAttribute("src", imagePath);
      inputImage.setAttribute("id", id);

      return inputImage;

    };

    // set current drawing tool
    function setDrawType(drawType) {
      console.log(drawType);
      g_DrawType = drawType;
    };

    // get relative position of mouse event
    function relativePosition(event, element) {
      var rect = element.getBoundingClientRect();
      return {
        x: Math.floor(event.clientX - rect.left),
        y: Math.floor(event.clientY - rect.top)
      };
    };

    // define drawing function
    function drawing(ctx, p) {
      if (g_DrawType === LINE_DRAW_TYPE) {
        ctx.beginPath();
        ctx.moveTo(g_pressPoint.x, g_pressPoint.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
      }
      else if (g_DrawType === RECTANGLE_DRAW_TYPE) {
        var w = p.x - g_pressPoint.x;
        var h = p.y - g_pressPoint.y;

        ctx.fillRect(g_pressPoint.x, g_pressPoint.y, w, h);
        ctx.strokeRect(g_pressPoint.x, g_pressPoint.y, w, h);
      }
    }

  </script>
</head>

<body>
  <div id="painter">
    <div id="toolbar"></div>
    <canvas id="mycanvas"></canvas>
  </div>
</body>

</html>